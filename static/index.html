<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>RPub - RSS to EPUB</title>
        <link rel="stylesheet" href="style.css" />
    </head>

    <body>
        <div id="login-overlay" class="hidden">
            <div id="login-box">
                <h2>Login Required</h2>
                <form id="login-form">
                    <input
                        type="text"
                        id="username"
                        placeholder="Username"
                        required
                    />
                    <input
                        type="password"
                        id="password"
                        placeholder="Password"
                        required
                    />
                    <button type="submit">Login</button>
                </form>
                <p id="login-error" style="color: var(--danger)"></p>
            </div>
        </div>
        <div class="container hidden">
            <header>
                <div class="header-content">
                    <h1>RPub</h1>
                    <p>RSS Aggregator & EPUB Generator</p>
                </div>
                <div class="status-indicator">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        style="color: var(--accent-blue); margin-right: 6px"
                    >
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path
                            d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                        ></path>
                    </svg>
                    <span id="connection-status">RPub</span>
                </div>
            </header>

            <main class="dashboard-grid">
                <!-- Left Column -->
                <div class="column left-col">
                    <section id="feeds-section" class="card">
                        <div class="card-header">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <path d="M4 11a9 9 0 0 1 9 9"></path>
                                <path d="M4 4a16 16 0 0 1 16 16"></path>
                                <circle cx="5" cy="19" r="1"></circle>
                            </svg>
                            <h2>Feeds</h2>
                        </div>
                        <ul id="feeds-list" class="item-list"></ul>
                        <form id="add-feed-form">
                            <div class="input-group">
                                <input
                                    type="url"
                                    name="url"
                                    placeholder="Feed URL"
                                    required
                                />
                                <input
                                    type="text"
                                    name="name"
                                    placeholder="Name (Optional)"
                                />
                            </div>
                            <div class="input-group">
                                <input
                                    type="number"
                                    name="concurrency_limit"
                                    placeholder="Limit (0=Uni)"
                                    min="0"
                                />
                                <button type="submit" class="add-btn">
                                    Add Feed
                                </button>
                            </div>
                        </form>
                    </section>

                    <!-- Schedules Section Moved to Right Column -->
                </div>

                <!-- Right Column -->
                <div class="column right-col">
                    <section id="generate-section" class="card">
                        <div class="card-header">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <polygon
                                    points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                                ></polygon>
                            </svg>
                            <h2>Manual Generation</h2>
                        </div>
                        <div class="generate-wrapper">
                            <button id="generate-btn">Generate EPUB Now</button>
                            <div id="status"></div>
                        </div>
                    </section>

                    <div class="sub-grid">
                        <section id="cover-section" class="card">
                            <div class="card-header">
                                <h2>Cover Image</h2>
                            </div>
                            <div class="cover-wrapper">
                                <div class="current-cover">
                                    <div class="cover-overlay">
                                        <span
                                            >DAILY RSS DIGEST<br />(Cover
                                            Preview)</span
                                        >
                                    </div>
                                    <img
                                        id="cover-preview"
                                        src="/cover.jpg"
                                        alt="Book Cover"
                                    />
                                </div>
                                <div class="upload-cover">
                                    <label for="cover-file" class="upload-label"
                                        >Replace Cover</label
                                    >
                                    <form id="upload-cover-form">
                                        <div class="file-input-wrapper">
                                            <input
                                                type="file"
                                                id="cover-file"
                                                name="cover"
                                                accept="image/jpeg"
                                                required
                                            />
                                        </div>
                                        <button type="submit" class="add-btn">
                                            Upload
                                        </button>
                                    </form>
                                    <div id="upload-status"></div>
                                </div>
                            </div>
                        </section>

                        <div class="column">
                            <section id="schedules-section" class="card">
                                <div class="card-header">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        height="20"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    >
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline
                                            points="12 6 12 12 16 14"
                                        ></polyline>
                                    </svg>
                                    <h2>Schedules</h2>
                                </div>
                                <ul id="schedules-list" class="item-list"></ul>
                                <form id="add-schedule-form">
                                    <div class="time-row">
                                        <select name="hour" required>
                                            <option value="" disabled selected>
                                                00
                                            </option>
                                            <script>
                                                for (let i = 0; i < 24; i++) {
                                                    const val = i
                                                        .toString()
                                                        .padStart(2, "0");
                                                    document.write(
                                                        `<option value="${val}">${val}</option>`,
                                                    );
                                                }
                                            </script>
                                        </select>
                                        <span>:</span>
                                        <select name="minute" required>
                                            <option value="" disabled selected>
                                                00
                                            </option>
                                            <script>
                                                for (
                                                    let i = 0;
                                                    i < 60;
                                                    i += 5
                                                ) {
                                                    const val = i
                                                        .toString()
                                                        .padStart(2, "0");
                                                    document.write(
                                                        `<option value="${val}">${val}</option>`,
                                                    );
                                                }
                                            </script>
                                        </select>
                                        <select
                                            name="timezone"
                                            id="timezone-select"
                                            required
                                        >
                                            <option value="" disabled selected>
                                                GMT+5:30
                                            </option>
                                        </select>
                                        <button type="submit" class="add-btn">
                                            Add Schedule
                                        </button>
                                    </div>
                                </form>
                            </section>

                            <section id="downloads-section" class="card">
                                <div class="card-header">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        height="20"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    >
                                        <path
                                            d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                                        ></path>
                                        <polyline
                                            points="7 10 12 15 17 10"
                                        ></polyline>
                                        <line
                                            x1="12"
                                            y1="15"
                                            x2="12"
                                            y2="3"
                                        ></line>
                                    </svg>
                                    <h2>Downloads</h2>
                                </div>
                                <ul id="downloads-list" class="item-list"></ul>
                            </section>
                        </div>

                        <section
                            id="email-config-section"
                            class="card"
                            style="grid-column: 1 / -1"
                        >
                            <div class="card-header">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <path
                                        d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                                    ></path>
                                    <polyline
                                        points="22,6 12,13 2,6"
                                    ></polyline>
                                </svg>
                                <h2>Email Configuration</h2>
                                <label
                                    style="
                                        margin-left: auto;
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                    "
                                >
                                    <span
                                        style="
                                            font-size: 0.9rem;
                                            color: var(--text-secondary);
                                        "
                                        >Enable Auto Send</span
                                    >
                                    <label class="switch">
                                        <input
                                            type="checkbox"
                                            id="enable_auto_send_toggle"
                                            name="enable_auto_send"
                                        />
                                        <span class="slider round"></span>
                                    </label>
                                </label>
                            </div>
                            <form id="email-config-form">
                                <div
                                    id="email-inputs-wrapper"
                                    style="
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        gap: 15px;
                                        margin-bottom: 15px;
                                    "
                                >
                                    <input
                                        type="text"
                                        name="smtp_host"
                                        placeholder="SMTP Host (e.g. smtp.gmail.com)"
                                        required
                                    />
                                    <input
                                        type="number"
                                        name="smtp_port"
                                        placeholder="Port (e.g. 587)"
                                        required
                                    />
                                    <input
                                        type="password"
                                        name="smtp_password"
                                        placeholder="SMTP Password (leave empty to keep)"
                                    />
                                    <input
                                        type="email"
                                        name="email_address"
                                        placeholder="Email Address"
                                        required
                                    />
                                    <input
                                        type="email"
                                        name="to_email"
                                        placeholder="To Email (Kindle)"
                                        required
                                    />
                                </div>
                                <button
                                    type="submit"
                                    class="add-btn"
                                    id="save-config-btn"
                                    style="width: 100%"
                                >
                                    Save Config
                                </button>
                            </form>
                            <div id="email-config-status"></div>
                        </section>
                    </div>
                </div>
            </main>
        </div>

        <script>
            let authHeader = localStorage.getItem("rpub_auth");

            const timezoneSelect = document.getElementById("timezone-select");
            const timezones = Intl.supportedValuesOf("timeZone");
            timezones.forEach((tz) => {
                const opt = document.createElement("option");
                opt.value = tz;
                opt.textContent = tz;
                if (tz === Intl.DateTimeFormat().resolvedOptions().timeZone) {
                    opt.selected = true;
                }
                timezoneSelect.appendChild(opt);
            });

            async function api(url, method = "GET", body = null) {
                const headers = { "Content-Type": "application/json" };
                if (authHeader) {
                    headers["Authorization"] = authHeader;
                }

                const options = { method, headers };
                if (body) options.body = JSON.stringify(body);

                const res = await fetch(url, options);

                if (res.status === 401) {
                    showLogin();
                    throw new Error("Unauthorized");
                }

                if (!res.ok) throw new Error(await res.text());
                return res.json().catch(() => {});
            }

            function showLogin() {
                document
                    .getElementById("login-overlay")
                    .classList.remove("hidden");

                const container = document.querySelector(".container");
                container.classList.remove("hidden");
                container.classList.add("blur-content");
            }

            function hideLogin() {
                document
                    .getElementById("login-overlay")
                    .classList.add("hidden");
                const container = document.querySelector(".container");
                container.classList.remove("blur-content");
                container.classList.remove("hidden");
            }

            async function handleLogin(e) {
                e.preventDefault();
                const u = document.getElementById("username").value;
                const p = document.getElementById("password").value;
                const creds = "Basic " + btoa(u + ":" + p);

                try {
                    const res = await fetch("/auth/check", {
                        headers: { Authorization: creds },
                    });

                    if (res.ok) {
                        authHeader = creds;
                        localStorage.setItem("rpub_auth", creds);
                        hideLogin();

                        loadFeeds();
                        loadSchedules();
                        loadDownloads();
                        loadEmailConfig();
                    } else {
                        document.getElementById("login-error").textContent =
                            "Invalid credentials";
                    }
                } catch (err) {
                    document.getElementById("login-error").textContent =
                        "Login failed";
                }
            }

            async function loadEmailConfig() {
                try {
                    const config = await api("/email-config");
                    if (config) {
                        const form =
                            document.getElementById("email-config-form");
                        form.elements.smtp_host.value = config.smtp_host;
                        form.elements.smtp_port.value = config.smtp_port;
                        form.elements.smtp_password.value =
                            config.smtp_password;
                        form.elements.email_address.value =
                            config.email_address;
                        form.elements.to_email.value = config.to_email;

                        const toggle = document.getElementById(
                            "enable_auto_send_toggle",
                        );
                        toggle.checked = config.enable_auto_send || false;
                        toggleVisibility();
                    } else {
                        const toggle = document.getElementById(
                            "enable_auto_send_toggle",
                        );
                        toggle.checked = false;
                        toggleVisibility();
                    }
                } catch (e) {
                    console.error("Failed to load email config", e);
                }
            }

            async function saveEmailConfig(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const status = document.getElementById("email-config-status");
                const btn = e.target.querySelector("button[type=submit]");

                try {
                    btn.disabled = true;
                    status.textContent = "Saving...";

                    await api("/email-config", "POST", {
                        smtp_host: formData.get("smtp_host"),
                        smtp_port: parseInt(formData.get("smtp_port") || 0),
                        smtp_username: formData.get("email_address"),
                        smtp_password: formData.get("smtp_password"),
                        email_address: formData.get("email_address"),
                        to_email: formData.get("to_email"),
                        enable_auto_send: document.getElementById(
                            "enable_auto_send_toggle",
                        ).checked,
                    });

                    status.textContent = "Saved successfully!";
                    status.style.color = "var(--accent-green)";
                    setTimeout(() => (status.textContent = ""), 3000);
                } catch (err) {
                    status.textContent = "Error: " + err.message;
                    status.style.color = "var(--danger)";
                } finally {
                    btn.disabled = false;
                }
            }

            async function loadFeeds() {
                try {
                    const feeds = await api("/feeds");
                    const list = document.getElementById("feeds-list");
                    list.innerHTML = feeds
                        .map(
                            (f) => `
                    <li>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="rss-icon" style="color: var(--accent-blue); flex-shrink: 0;"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>
                            <span>${f.name || f.url} <small>(${f.concurrency_limit === 0 ? "Unlimited" : f.concurrency_limit + " threads"})</small></span>
                        </div>
                        <button onclick="deleteFeed(${f.id})" class="delete-btn">×</button>
                    </li>
                `,
                        )
                        .join("");
                } catch (e) {
                    console.error(e);
                }
            }

            async function addFeed(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                await api("/feeds", "POST", {
                    url: formData.get("url"),
                    name: formData.get("name") || null,
                    concurrency_limit: parseInt(
                        formData.get("concurrency_limit") || "0",
                        10,
                    ),
                });
                e.target.reset();
                loadFeeds();
            }

            async function deleteFeed(id) {
                if (confirm("Delete this feed?")) {
                    await api(`/feeds/${id}`, "DELETE");
                    loadFeeds();
                }
            }

            async function loadSchedules() {
                try {
                    const schedules = await api("/schedules");
                    const list = document.getElementById("schedules-list");

                    list.innerHTML = schedules
                        .map((s) => {
                            const date = new Date(s.time);
                            const timeStr = new Intl.DateTimeFormat("default", {
                                hour: "numeric",
                                minute: "numeric",
                                timeZoneName: "short",
                            }).format(date);

                            return `
                    <li>
                        <span>${timeStr}</span>
                        <button onclick="deleteSchedule(${s.id})" class="delete-btn">×</button>
                    </li>
                `;
                        })
                        .join("");
                } catch (e) {
                    console.error(e);
                }
            }

            async function addSchedule(e) {
                e.preventDefault();
                const formData = new FormData(e.target);

                const hour = parseInt(formData.get("hour"), 10);
                const minute = parseInt(formData.get("minute"), 10);
                const timezone = formData.get("timezone");

                if (isNaN(hour) || isNaN(minute) || !timezone) {
                    alert("Please select Hour, Minute, and Timezone.");
                    return;
                }

                await api("/schedules", "POST", {
                    hour,
                    minute,
                    timezone,
                });

                loadSchedules();
            }

            async function deleteSchedule(id) {
                if (confirm("Delete this schedule?")) {
                    await api(`/schedules/${id}`, "DELETE");
                    loadSchedules();
                }
            }

            async function loadDownloads() {
                try {
                    const files = await api("/downloads");
                    const list = document.getElementById("downloads-list");
                    list.innerHTML = files
                        .map(
                            (f) => `
                    <li>
                        <a href="/epubs/${f}" download>${f}</a>
                    </li>
                `,
                        )
                        .join("");
                } catch (e) {
                    console.error(e);
                }
            }

            async function generate() {
                const btn = document.getElementById("generate-btn");
                const status = document.getElementById("status");
                btn.disabled = true;
                status.textContent = "Requesting generation...";

                try {
                    const res = await fetch("/generate", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            ...(authHeader
                                ? { Authorization: authHeader }
                                : {}),
                        },
                        body: JSON.stringify({
                            feeds: [],
                            send_email: document.getElementById(
                                "enable_auto_send_toggle",
                            ).checked,
                        }),
                    });

                    if (res.ok) {
                        status.textContent =
                            "Generation started in background. Please wait...";

                        let checks = 0;
                        const interval = setInterval(async () => {
                            checks++;
                            await loadDownloads();
                            if (checks > 10) {
                                clearInterval(interval);
                                status.textContent =
                                    "Generation started. Check downloads list below.";
                            }
                        }, 2000);
                    } else if (res.status === 401) {
                        showLogin();
                        status.textContent = "Authentication required.";
                    } else {
                        status.textContent = "Error: " + (await res.text());
                    }
                } catch (e) {
                    status.textContent = "Error: " + e.message;
                } finally {
                    btn.disabled = false;
                }
            }

            async function uploadCover(e) {
                e.preventDefault();
                const form = e.target;
                const status = document.getElementById("upload-status");
                const fileInput = document.getElementById("cover-file");

                if (fileInput.files.length === 0) return;

                const formData = new FormData();
                formData.append("cover", fileInput.files[0]);

                status.textContent = "Uploading...";

                try {
                    const headers = {};
                    if (authHeader) headers["Authorization"] = authHeader;

                    const res = await fetch("/cover", {
                        method: "POST",
                        headers: headers,
                        body: formData,
                    });

                    if (res.ok) {
                        status.textContent = "Cover updated successfully!";
                        status.style.color = "var(--accent-green)";

                        document.getElementById("cover-preview").src =
                            "/cover.jpg?t=" + new Date().getTime();
                        form.reset();
                    } else if (res.status === 401) {
                        showLogin();
                        status.textContent = "Authentication required.";
                        status.style.color = "var(--danger)";
                    } else {
                        status.textContent = "Error: " + (await res.text());
                        status.style.color = "var(--danger)";
                    }
                } catch (err) {
                    status.textContent = "Error: " + err.message;
                    status.style.color = "var(--danger)";
                }
            }

            async function checkAuth() {
                try {
                    await api("/auth/check");

                    document
                        .querySelector(".container")
                        .classList.remove("hidden");
                    loadFeeds();
                    loadSchedules();
                    loadDownloads();
                    loadEmailConfig();
                } catch (e) {}
            }

            function toggleVisibility() {
                const toggle = document.getElementById(
                    "enable_auto_send_toggle",
                );
                const wrapper = document.getElementById("email-inputs-wrapper");
                const btn = document.getElementById("save-config-btn");

                if (toggle.checked) {
                    wrapper.style.display = "grid";
                    btn.style.display = "block";
                } else {
                    wrapper.style.display = "none";
                    btn.style.display = "none";
                }
            }

            document
                .getElementById("enable_auto_send_toggle")
                .addEventListener("change", (e) => {
                    toggleVisibility();
                    if (!e.target.checked) {
                        const form =
                            document.getElementById("email-config-form");

                        const dummyEvent = {
                            preventDefault: () => {},
                            target: form,
                        };
                        saveEmailConfig(dummyEvent);
                    }
                });
            document
                .getElementById("login-form")
                .addEventListener("submit", handleLogin);
            document
                .getElementById("add-feed-form")
                .addEventListener("submit", addFeed);
            document
                .getElementById("add-schedule-form")
                .addEventListener("submit", addSchedule);
            document
                .getElementById("generate-btn")
                .addEventListener("click", generate);
            document
                .getElementById("upload-cover-form")
                .addEventListener("submit", uploadCover);
            document
                .getElementById("email-config-form")
                .addEventListener("submit", saveEmailConfig);

            checkAuth();
        </script>
    </body>
</html>
