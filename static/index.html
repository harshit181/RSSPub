<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPub - RSS to EPUB</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>RPub</h1>
            <p>RSS Aggregator & EPUB Generator</p>
        </header>

        <main>
            <!-- Feeds Section -->
            <section id="feeds-section">
                <h2>Feeds</h2>
                <ul id="feeds-list" class="item-list"></ul>
                <form id="add-feed-form">
                    <input type="url" name="url" placeholder="Feed URL" required>
                    <input type="text" name="name" placeholder="Name (Optional)">
                    <input type="number" name="concurrency_limit" placeholder="Limit (0=Unl)" min="0"
                        style="width: 100px;">
                    <button type="submit">Add Feed</button>
                </form>
            </section>

            <hr>

            <!-- Schedules Section -->
            <section id="schedules-section">
                <h2>Schedules</h2>
                <ul id="schedules-list" class="item-list"></ul>
                <form id="add-schedule-form">
                    <input type="text" name="cron_expression" placeholder="Cron Expression (e.g., 0 0 8 * * *)"
                        required>
                    <button type="submit">Add Schedule</button>
                </form>
                <p class="hint">Format: sec min hour day_of_month month day_of_week year</p>
            </section>

            <hr>

            <!-- Generate Section -->
            <section id="generate-section">
                <h2>Manual Generation</h2>
                <button id="generate-btn">Generate EPUB Now</button>
                <div id="status"></div>
            </section>

            <hr>

            <!-- Downloads Section -->
            <section id="downloads-section">
                <h2>Downloads</h2>
                <ul id="downloads-list" class="item-list"></ul>
            </section>
        </main>
    </div>

    <script>
        // API Helpers
        async function api(url, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(await res.text());
            return res.json().catch(() => { });
        }

        // Feeds
        async function loadFeeds() {
            const feeds = await api('/feeds');
            const list = document.getElementById('feeds-list');
            list.innerHTML = feeds.map(f => `
                <li>
                    <span>${f.name || f.url} <small>(${f.concurrency_limit === 0 ? 'Unlimited' : f.concurrency_limit + ' threads'})</small></span>
                    <button onclick="deleteFeed(${f.id})" class="delete-btn">×</button>
                </li>
            `).join('');
        }

        async function addFeed(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            await api('/feeds', 'POST', {
                url: formData.get('url'),
                name: formData.get('name') || null,
                concurrency_limit: parseInt(formData.get('concurrency_limit') || '0', 10)
            });
            e.target.reset();
            loadFeeds();
        }

        async function deleteFeed(id) {
            if (confirm('Delete this feed?')) {
                await api(`/feeds/${id}`, 'DELETE');
                loadFeeds();
            }
        }

        // Schedules
        async function loadSchedules() {
            const schedules = await api('/schedules');
            const list = document.getElementById('schedules-list');
            list.innerHTML = schedules.map(s => `
                <li>
                    <span>${s.cron_expression}</span>
                    <button onclick="deleteSchedule(${s.id})" class="delete-btn">×</button>
                </li>
            `).join('');
        }

        async function addSchedule(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            await api('/schedules', 'POST', {
                cron_expression: formData.get('cron_expression')
            });
            e.target.reset();
            loadSchedules();
        }

        async function deleteSchedule(id) {
            if (confirm('Delete this schedule?')) {
                await api(`/schedules/${id}`, 'DELETE');
                loadSchedules();
            }
        }

        // Downloads
        async function loadDownloads() {
            const files = await api('/downloads');
            const list = document.getElementById('downloads-list');
            list.innerHTML = files.map(f => `
                <li>
                    <a href="/epubs/${f}" download>${f}</a>
                </li>
            `).join('');
        }

        // Generate
        async function generate() {
            const btn = document.getElementById('generate-btn');
            const status = document.getElementById('status');
            btn.disabled = true;
            status.textContent = 'Generating...';

            try {
                const res = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feeds: [] }) // Empty list triggers DB fetch
                });

                if (res.ok) {
                    status.textContent = 'Done! Checking downloads...';
                    loadDownloads();
                } else {
                    status.textContent = 'Error: ' + await res.text();
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
            } finally {
                btn.disabled = false;
            }
        }

        // Init
        document.getElementById('add-feed-form').addEventListener('submit', addFeed);
        document.getElementById('add-schedule-form').addEventListener('submit', addSchedule);
        document.getElementById('generate-btn').addEventListener('click', generate);

        loadFeeds();
        loadSchedules();
        loadDownloads();
    </script>
</body>

</html>